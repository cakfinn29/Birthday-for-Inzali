<script>
const LOVE_START = new Date("2024-01-01T00:00:00");
const TYPE_SPEED = 18;
const SONG_MAX_VOL = 0.8;

const btn = document.getElementById("continueBtn");
const text = document.getElementById("giftText");
const intro = document.getElementById("introText");
const questionText = document.getElementById("questionText");
const song = document.getElementById("song");
const click = document.getElementById("click");
const switchSfx = document.getElementById("switchSfx");

const candleWrap = document.getElementById("candleWrap");
const flame = document.getElementById("flame");
const smoke = document.getElementById("smoke");
const candleHint = document.getElementById("candleHint");
const cake = document.getElementById("cake");

const photoWrap = document.getElementById("photoWrap");
const photoBox1 = document.getElementById("photoBox1");
const photoBox2 = document.getElementById("photoBox2");
const secretBtn = document.getElementById("secretBtn");
const secretNote = document.getElementById("secretNote");

const counterRow = document.getElementById("counterRow");
const counterText = document.getElementById("counterText");
const starBtn = document.getElementById("starBtn");

const starsCanvas = document.getElementById("starsCanvas");
const confettiCanvas = document.getElementById("confettiCanvas");

const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightboxImg");
const lightboxHint = document.getElementById("lightboxHint");

window.addEventListener("load", () => {
  setTimeout(()=>document.body.classList.add("cinematic"), 220);
});

/* ===== Starry toggle ===== */
let starOn = false;
if(starBtn){
  starBtn.addEventListener("click", ()=>{
    starOn = !starOn;
    document.body.classList.toggle("starry", starOn);
    starBtn.textContent = starOn ? "âœ¨ Normal" : "â­ Starry";

    // ðŸ”Š play switch sound (FIXED: now inside the click handler)
    if(switchSfx){
      try{
        switchSfx.currentTime = 0;
        switchSfx.volume = 0.9;
        switchSfx.play().catch(()=>{});
      }catch(e){}
    }
  });
}

/* ===== Stars canvas ===== */
const sctx = starsCanvas.getContext("2d");
let stars = [];
function resizeStars(){
  starsCanvas.width = window.innerWidth * devicePixelRatio;
  starsCanvas.height = window.innerHeight * devicePixelRatio;
  starsCanvas.style.width = window.innerWidth + "px";
  starsCanvas.style.height = window.innerHeight + "px";
  const count = Math.floor((window.innerWidth * window.innerHeight) / 12000);
  stars = Array.from({length: count}, () => ({
    x: Math.random() * starsCanvas.width,
    y: Math.random() * starsCanvas.height,
    r: (Math.random()*1.6 + 0.4) * devicePixelRatio,
    a: Math.random()*0.6 + 0.2,
    tw: Math.random()*0.02 + 0.008
  }));
}
function drawStars(){
  sctx.clearRect(0,0,starsCanvas.width, starsCanvas.height);

  const g = sctx.createLinearGradient(0,0,0,starsCanvas.height);
  g.addColorStop(0, "rgba(6,26,58,0.92)");
  g.addColorStop(0.55, "rgba(10,37,80,0.88)");
  g.addColorStop(1, "rgba(4,11,26,0.96)");
  sctx.fillStyle = g;
  sctx.fillRect(0,0,starsCanvas.width, starsCanvas.height);

  for(const st of stars){
    st.a += st.tw * (Math.random() > 0.5 ? 1 : -1);
    st.a = Math.max(0.08, Math.min(0.9, st.a));
    sctx.beginPath();
    sctx.fillStyle = `rgba(255,255,255,${st.a})`;
    sctx.arc(st.x, st.y, st.r, 0, Math.PI*2);
    sctx.fill();
  }
  requestAnimationFrame(drawStars);
}
window.addEventListener("resize", resizeStars);
resizeStars();
drawStars();

/* ===== Confetti canvas ===== */
const cctx = confettiCanvas.getContext("2d");
let confetti = [];
function resizeConfetti(){
  confettiCanvas.width = window.innerWidth * devicePixelRatio;
  confettiCanvas.height = window.innerHeight * devicePixelRatio;
  confettiCanvas.style.width = window.innerWidth + "px";
  confettiCanvas.style.height = window.innerHeight + "px";
}
window.addEventListener("resize", resizeConfetti);
resizeConfetti();

function confettiBurst(x, y){
  const colors = ["#ffd86b","#ff4d9d","#ffffff","#7bf1ff","#b86bff"];
  const N = 180;
  for(let i=0;i<N;i++){
    confetti.push({
      x, y,
      vx: (Math.random()*10 - 5) * devicePixelRatio,
      vy: (Math.random()*-12 - 4) * devicePixelRatio,
      g: (0.22 + Math.random()*0.18) * devicePixelRatio,
      r: (3 + Math.random()*5) * devicePixelRatio,
      rot: Math.random()*Math.PI,
      vr: (Math.random()*0.25 - 0.125),
      life: 140 + Math.random()*70,
      color: colors[Math.floor(Math.random()*colors.length)]
    });
  }
}
function drawConfetti(){
  cctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  confetti = confetti.filter(p => p.life > 0);
  for(const p of confetti){
    p.life--;
    p.vy += p.g;
    p.x += p.vx;
    p.y += p.vy;
    p.rot += p.vr;

    cctx.save();
    cctx.translate(p.x, p.y);
    cctx.rotate(p.rot);
    cctx.fillStyle = p.color;
    cctx.globalAlpha = Math.min(1, p.life/80);
    cctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
    cctx.restore();
  }
  requestAnimationFrame(drawConfetti);
}
drawConfetti();

function playSongFadeIn(audio, duration = 2500){
  audio.volume = 0;
  audio.currentTime = 0;
  audio.play().catch(()=>{});
  const steps = 24;
  const stepTime = duration / steps;
  let i = 0;
  const fade = setInterval(()=>{
    i++;
    audio.volume = Math.min(SONG_MAX_VOL, (i/steps) * SONG_MAX_VOL);
    if(i >= steps) clearInterval(fade);
  }, stepTime);
}

function splitIntoSentences(paragraph){
  const parts = paragraph.replace(/\s+/g, " ").trim().match(/[^.!?]+[.!?]?\s*/g);
  return parts ? parts.map(s=>s.trim()).filter(Boolean) : [paragraph.trim()];
}
async function typeLine(el, textToType){
  el.textContent = "";
  for(let i=0;i<textToType.length;i++){
    el.textContent += textToType[i];
    await new Promise(r=>setTimeout(r, TYPE_SPEED));
  }
}
async function typewriterMessage(container, paragraphs){
  container.innerHTML = "";
  const lines = [];
  paragraphs.forEach(p => splitIntoSentences(p).forEach(sentence => lines.push(sentence)));
  for(const lineText of lines){
    const line = document.createElement("div");
    line.className = "line";
    container.appendChild(line);
    await typeLine(line, lineText);
  }
  const sig = document.createElement("div");
  sig.className = "signature";
  container.appendChild(sig);
  await typeLine(sig, "â€” Canzy ðŸ’›");
}

function formatDuration(ms){
  const s = Math.floor(ms/1000);
  const days = Math.floor(s / 86400);
  const hrs = Math.floor((s % 86400) / 3600);
  const mins = Math.floor((s % 3600) / 60);
  const secs = s % 60;
  return `${days} days â€¢ ${hrs}h ${mins}m ${secs}s`;
}
function startCounter(){
  counterRow.classList.remove("hidden");
  const tick = ()=>{
    const now = new Date();
    const diff = now - LOVE_START;
    counterText.textContent = `â³ Love counter: ${formatDuration(diff)}`;
  };
  tick();
  setInterval(tick, 1000);
}

/* ===== Candle + photos ===== */
let candleBlown = false;
function blowCandle(){
  if(candleBlown) return;
  candleBlown = true;

  flame.style.transition = "opacity 450ms ease, transform 450ms ease";
  flame.style.opacity = "0";
  flame.style.transform = "translateX(-50%) scale(.7)";
  smoke.classList.remove("run");
  void smoke.offsetWidth;
  smoke.classList.add("run");

  candleHint.textContent = "A wish for youâ€¦ ðŸ’«";

  setTimeout(()=>{
    photoWrap.classList.add("show");
    setTimeout(()=>photoBox1.classList.add("revealed"), 180);
  }, 650);
}
flame.addEventListener("click", blowCandle);
cake.addEventListener("click", blowCandle);

function showSecondPhoto(){
  if(!photoBox2.classList.contains("hidden")) return;
  photoBox2.classList.remove("hidden");
  setTimeout(()=>photoBox2.classList.add("revealed"), 80);
  secretNote.textContent = "Now you have two memories ðŸ’ž";
}
secretBtn.addEventListener("click", showSecondPhoto);
secretBtn.addEventListener("keydown", (e)=>{
  if(e.key==="Enter" || e.key===" "){
    e.preventDefault();
    showSecondPhoto();
  }
});

/* ===== Lightbox ===== */
function openLightbox(src){
  lightboxImg.src = src;
  lightbox.classList.add("show");
  lightboxHint.style.display = "block";
  lightbox.setAttribute("aria-hidden", "false");
}
function closeLightbox(){
  lightbox.classList.remove("show");
  lightboxHint.style.display = "none";
  lightbox.setAttribute("aria-hidden", "true");
  lightboxImg.src = "";
}
lightbox.addEventListener("click", closeLightbox);
photoBox1.addEventListener("click", ()=>openLightbox(photoBox1.dataset.full));
photoBox2.addEventListener("click", ()=>openLightbox(photoBox2.dataset.full));

/* ===== Continue button ===== */
btn.onclick = async ()=>{
  try{
    click.currentTime = 0;
    click.volume = 0.95;
    click.play().catch(()=>{});
  }catch(e){}

  playSongFadeIn(song, 2500);
  document.body.classList.add("cinematic");

  const r = btn.getBoundingClientRect();
  const cx = (r.left + r.width/2) * devicePixelRatio;
  const cy = (r.top + r.height/2) * devicePixelRatio;
  confettiBurst(cx, cy);

  questionText.style.display = "none";
  intro.style.display = "none";
  btn.classList.add("fade");
  setTimeout(()=>btn.style.display="none", 350);

  candleWrap.classList.remove("hidden");
  text.classList.remove("hidden");
  requestAnimationFrame(()=>text.classList.add("show"));
  startCounter();

  const paragraphs = [
    "Happy Birthday to the girl who changed my world.",
    "You are the most beautiful chapter of my life. Every day with you feels like a blessing, but today is extra special because itâ€™s the day the world received you.",
    "Thank you for your love, your smile, your patience, and the way you make my heart feel safe. I promise to stand beside you, support your dreams, and love you more with every passing year.",
    "May your birthday be as soft, warm, and magical as your hugs.",
    "I love you more than words can explain. ðŸŽ‚ðŸ’˜"
  ];
  await typewriterMessage(text, paragraphs);
};
</script>
